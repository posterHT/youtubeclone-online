<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Video</title>
    <link rel="stylesheet" href="style.css?v=1.4">
    <style>
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 en-boy oranı */
            height: 0;
            overflow: hidden;
        }

        .video-container iframe {
            border-radius: 5px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        * {
            background-color: #1f1f1f;
            color: white;
        }

        .container {
            background-color: #1c1c1c;
        }
    </style>
</head>

<body>
    <nav class="flex-div">
        <div class="nav-left flex-div">
            <img src="images/menu.png" class="menu-icon">
            <a href="./"><img src="images/logo.png?v" class="logo"></a>
        </div>

        <div class="nav-middle flex-div">
            <div class="search-box flex-div">
                <input type="text" placeholder="Search" id="searchTextBox" onkeypress="keypress(event)">
                <img src="images/search.png" onclick="search()">
            </div>
            <img src="images/voice-search.png" class="mic-icon" onclick="search()">
        </div>

        <div class="nav-right flex-div">
            <img src="images/upload.png">
            <img src="images/more.png">
            <img src="images/notification.png">
            <img src="images/Jack.png" class="user-icon">
        </div>
    </nav>

    <div class="container play-container">
        <div class="row">
            <div class="play-video">
                <!-- <video controls autoplay>
                    <source src="images/video.mp4" type="video/mp4">
                </video> -->
                <div class="video-container">

                    <iframe id="ytplayer" width="" height="500" src="" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>
                <!-- <div class="tags">
                    <a href="">#Coding</a>
                    <a href="">#HTML</a>
                    <a href="">#CSS</a>
                    <a href="">#JavaScript</a>
                </div> -->
                <h3 id="video-title"></h3>
                <select class="form-control formte" required>
                    <option selected disabled>Select Download Formate</option>
                    <option value="mp3">Mp3</option>
                    <option value="144">144 Mp4</option>
                    <option value="360">360 Mp4</option>
                    <option value="480">480 Mp4</option>
                    <option value="720">720 Mp4</option>
                    <option value="1080">1080 Mp4</option>
                    <option value="4k">4k Mp4</option>
                    <option value="8k">8k Mp4</option>
                </select>

                <div class="play-video-info">
                    <p>1225 Views &bull; 2 days ago</p>
                    <div>
                        <a href=""><img src="images/like.png">125</a>
                        <a href=""><img src="images/dislike.png">2</a>
                        <a href=""><img src="images/share.png">Share</a>
                        <a href=""><img src="images/save.png">Save</a>

                    </div>
                </div>
                <hr>
                <div class="publisher">
                    <img src="images/Jack.png">
                    <div>
                        <p>Video Channel</p>
                        <span>500k Subscribers</span>
                    </div>
                    <br>
                    <button style="background-color: cornflowerblue;" id="downloadButton"
                        onclick="downloadVideo()">Download</button>

                    <button>Subscribe</button>

                </div>
                <div class="vid-description">
                    <p>PosterHT Youtube Clone Template Online</p>
                    <p>Download butonu ile bu videoyu sunucuya kaydedebilir ve indirebilirsiniz</p>
                    <hr>
                    <h4>345 Comments</h4>
                </div>

                <div class="add-comment">
                    <img src="images/Jack.png">
                    <input type="text" placeholder="Write comments...">
                </div>

                <div class="last-comment">
                    <img src="images/tom.png">
                    <div>
                        <h3>Jack Nicholson <span>2 days ago</span></h3>
                        <p>Elenmusk mı o kim hayatımda ilk defa duyuyorum.</p>
                    </div>
                    <div class="acomment-action">
                        <img src="images/like.png">
                        <span>244</span>
                        <img src="images/dislike.png">
                        <span>2</span>
                        <span>REPLY</span>
                        <a href="">All Replies</a>
                    </div>

                </div>
                <div class="last-comment">
                    <img src="images/Jack.png">
                    <div>
                        <h3>Tom Tomhalson <span>5 days ago</span></h3>
                        <p>Bu adam çok zeki dostum bakarmısın tasarladığı paltforma</p>
                    </div>
                    <div class="acomment-action">
                        <img src="images/like.png">
                        <span>900</span>
                        <img src="images/dislike.png">
                        <span>0</span>
                        <span>REPLY</span>
                        <a href="">All Replies</a>
                    </div>

                </div>

            </div>
            <div class="right-sidebar">
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail1.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail2.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail3.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail4.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail5.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail6.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail7.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
                <div class="side-video-list">
                    <a href="" class="small-thumbnail">
                        <img src="images/thumbnail8.png">
                    </a>
                    <div class="vid-info">
                        <a href="">Best channel that help you to be a web developer</a>
                        <p>Example Channel</p>
                        <p>15k views</p>
                    </div>
                </div>
            </div>


        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
    <script>
        
        function getQueryParams() {
            var queryParams = {};
            var queryString = window.location.search.substring(1);
            var keyValues = queryString.split('&');

            for (var i = 0; i < keyValues.length; i++) {
                var keyValue = keyValues[i].split('=');
                var key = decodeURIComponent(keyValue[0]);
                var value = decodeURIComponent(keyValue[1] || '');
                queryParams[key] = value;
            }

            return queryParams;
        }
        // ../play-video.html?id=...
        // id is query
        function dosyaVarlikKontrol(url) {
            return fetch(url, { method: 'HEAD' })
                .then(function (response) {
                    return response.ok;
                })
                .catch(function (error) {
                    return false;
                });
        }
        function exi(urlToFile) {
            var xhr = new XMLHttpRequest();
            xhr.open('HEAD', urlToFile, false);
            xhr.send();

            if (xhr.status == "404") {
                console.log("File doesn't exist");
                return false;
            } else {
                console.log("File exists");
                return true;
            }
        }

        var video_id;
        // window.onload = function () {
        var queryParams = getQueryParams();
        video_id = queryParams['id'];

        if (video_id) {
            console.log('id:', video_id);

            link = "https://youtube.com/watch?v=" + video_id;

            $.get("php/resolve.php?format=360"  + "&video_url=" + encodeURI(link), function (data) {
                if (data == "" || data == null) _("downloadButton").innerHTML = "Fail!";
                VideoInfo(data.title);
            }, "json");


            
            $.get("stroage/check.php?file=" + video_id.toUpperCase() + "&v=" + Date.now(), function (data) {
                // alert(data);
                if (data == "true") {
                    console.log('Dosya mevcut');
                    document.getElementById("ytplayer").src = dosyaURL;
                } else {
                    console.log('Dosya mevcut değil');
                    document.getElementById("ytplayer").src = "https://www.youtube.com/embed/" + video_id + "?autoplay=1"
                }
            });
        } else {
            console.log('ID parametresi bulunamadı.');
            // window.location.href = "index.html";
        }
        // };

        function _(id) {
            return document.getElementById(id);
        }
        function VideoInfo(title){
            _("video-title").innerHTML = title;
        }

        function downloadVideo() {
            link = "https://youtube.com/watch?v=" + video_id;
            format = $(".formte").children("option:selected").val();;
            start = 1;
            end = 1;

            $.get("php/resolve.php?format=" + format + "&video_url=" + encodeURI(link), function (data) {
                if (data == "" || data == null) _("downloadButton").innerHTML = "Fail!";
                p(data.id);
                _("downloadButton").innerHTML = "Link Resolved";
            }, "json");


            function p(i) {
                $.get("https://loader.to/ajax/progress.php?id=" + i, function (data, status) {
                    _("downloadButton").innerHTML = data.progress + "%";

                    console.log("Link Loading " + data.progress + "%")
                    if (data.download_url != null && data.success == 1) {
                        console.log(data.download_url);
                        _("downloadButton").innerHTML = "Downloading...";

                        $.get("stroage/downloadvideo.php?link=" + data.download_url + "&id=" + video_id.toUpperCase() + "&v=" + Date.now(), function (data) {
                            if (data == "success") {
                                _("downloadButton").innerHTML = "Success";
                                console.log("Download Success");
                            }
                            else {
                                _("downloadButton").innerHTML = "Failed";
                                console.log("Download Failed!");
                            }
                        })
                        return;
                    }
                    setTimeout(p.bind(null, i), 750);
                }, "json").fail(function () {
                    setTimeout(p.bind(null, i), 750);
                });
            } //automatic country determination. function initCountry(){ return new Promise((resolve, reject)=>{ var xhr=new XMLHttpRequest(); xhr.timeout=3000; xhr.onreadystatechange=function (){ if (this.readyState==4){ if (this.status==200){ countryCode=countryCodeExpression.exec(this.responseText) ip=userIPExpression.exec(this.responseText) if (countryCode===null || countryCode[1]==='' || ip===null || ip[1]===''){ reject('IP/Country code detection failed');} let result={ "countryCode":countryCode[1], "IP":ip[1]}; user_country=countryCode[1]; resolve(result)} else{ reject(xhr.status)}}} xhr.ontimeout=function (){ reject('timeout')} xhr.open('GET', 'https://www.cloudflare.com/cdn-cgi/trace', true); xhr.send();});} initCountry(); 

        }
    </script>

    <script>
        function keypress(event) {
            if (event.keyCode == 13) {
                search();
            }
        }

        function search() {
            window.location.href = "index.html?q=" + document.getElementById("searchTextBox").value;
        }

    </script>
</body>

</html>